#############################################################################
# panos-parser
#############################################################################

block parser panos-parser (prefix(".panos.") template("${LEGACY_MSGHDR}${MESSAGE}")) {
  channel {

    # 1. Header Parsing & Timestamp
    parser {
      regexp-parser(
        prefix(".panos.")
        patterns('.*(?<palo_ts>[0-9]{4}-[0-9]{2}-[0-9]{2}T[^ ]+) (?<palo_host>[^ ]+) - - - - +(?:<(?<palo_pri>[0-9]+)>[0-9]+ )?(?<palo_msg>.*)')
        template("${MESSAGE}")
      );
    };

    parser {
      date-parser(format("%Y-%m-%dT%H:%M:%S%z") template("${.panos.palo_ts}"));
    };

    # 2. Field Setup (HOST, MESSAGE) & Cleanup
    rewrite {
      set("${.panos.palo_host}", value("HOST") condition("${.panos.palo_host}" ne ""));
      set("${.panos.palo_msg}", value("MESSAGE") condition("${.panos.palo_msg}" ne ""));
      unset(value(".panos.palo_ts"));
      unset(value(".panos.palo_host"));
      unset(value(".panos.palo_msg"));
      unset(value(".panos.palo_pri"));
      unset(value("0"));
      unset(value("1"));
      unset(value("2"));
      unset(value("3"));
      unset(value("4"));
      unset(value("5"));
    };

    # Common fields - set dot-nv-pairs
    parser {
      csv-parser(
        columns("future_use1","receive_time","serial","type","subtype","future_use2","time_generated", "tmp")
        delimiters(',')
        prefix("`prefix`")
        flags(greedy)
        template("`template`")
      );
    };

    if (match('SYSTEM' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("vsys","eventid","object","future_use3","future_use4","module","severity","opaque","seqno","actionflags",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    }
    elif (match('audit' value('`prefix`serial') type(string))) {
      # Audit Log Handling
      rewrite {
        # serial="audit", type="2817" (in sample)
        # Map fields as requested
        set("${`prefix`type}", value("`prefix`serial")); # Set serial to 2817 (original type)
        set("audit", value("`prefix`type"));
        
        set("${`prefix`future_use2}", value("`prefix`user"));
        set("${`prefix`time_generated}", value("`prefix`description"));
        set("${`prefix`tmp}", value("`prefix`result"));

        # Remove fields with incorrect values
        unset(value("`prefix`time_generated"));
        unset(value("`prefix`future_use2"));
        unset(value("`prefix`tmp"));
      };
    }
    elif (match('CONFIG' value('`prefix`type') type(string))) {
      if {
          # non-custom format first
          parser {
            csv-parser(
              columns("host", "vsys","cmd","admin","client","result","path","seqno","actionflags",
                      "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name")
              prefix("`prefix`")
              template("${`prefix`tmp}")
              delimiters(',')
              drop-invalid(yes)
            );
          };
      } else {
          # custom log with "before_change_detail" and "after_change_detail"
          parser {
            csv-parser(
              columns("host", "vsys","cmd","admin","client","result","path",
                      "before_change_detail","after_change_detail","seqno","actionflags",
                      "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name")
              prefix("`prefix`")
              template("${`prefix`tmp}")
              delimiters(',')
            );
          };
         filter { "${`prefix`device_name}" ne "" };
      };
    }
    elif (match('THREAT' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("src","dst","natsrc","natdst","rule","srcuser","dstuser","app","vsys","from","to",
                  "inbound_if","outbound_if","logset","future_use3","sessionid","repeatcnt",
                  "sport","dport","natsport","natdport","flags","proto","action","misc",
                  "threatid","category","severity","direction","seqno","actionflags",
                  "srcloc","dstloc","future_use4","contenttype","pcap_id","filedigest",
                  "cloud","url_idx","user_agent","filetype","xff","referer","sender","subject","recipient","reportid",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name","future_use5",
                  "src_uuid","dst_uuid","http_method","tunnel_id/imsi","monitor_tag/imei",
                  "parent_session_id","parent_start_time","tunnel","thr_category","contentver",
                  "future_use6","assoc_id","ppid","http_headers","url_category_list",
                  "rule_uuid","http2_connection")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    }
    elif (match('TRAFFIC' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("src","dst","natsrc","natdst","rule","srcuser","dstuser","app","vsys","from","to","inbound_if","outbound_if",
                  "logset","future_use3","sessionid","repeatcnt","sport","dport","natsport","natdport","flags","proto","action",
                  "bytes","bytes_sent","bytes_received","packets","start","sec","category","future_use4","seqno","actionflags",
                  "srcloc","dstloc","future_use5","pkts_sent","pkts_received","session_end_reason",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name",
                  "action_source","src_uuid","dst_uuid","tunnel_id/imsi","monitortag/imei",
                  "parent_session_id","parent_start_time","tunnel","assoc_id",
                  "chunks","chunks_sent","chunks_received","rule_uuid",
                  "http2_connection","link_change_count",
                  "policy_id","link_switches",
                  "sdwan_cluster","sdwan_device_type","sdwan_cluster_type","sdwan_site","dynusergroup_name")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    }
    elif (match('HIP-MATCH' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("srcuser","vsys","machine_name","os","src","matchname","repeatcnt","matchtype","future_use3","future_use4","seqno","actionflags",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name",
                  "vsys_id","srcipv6","hostid","serialnumber")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    }
    elif (match('CORRELATION' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("src","srcuser","vsys","category","severity",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name",
                  "vsys_id","objectname","object_id","evidence")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    }
    elif (match('USERID' value('`prefix`type') type(string))) {
      parser {
        csv-parser(
          columns("vsys","ip","user","datasourcename","eventid","repeatcnt","timeout","beginport","endport","datasource","datasourcetype","seqno","actionflags",
                  "dg_hier_level_1","dg_hier_level_2","dg_hier_level_3","dg_hier_level_4","vsys_name","device_name",
                  "vsys_id","factortype","factorcompletiontime","factorno","future_use3","future_use4","ugflags","userbysource")
          prefix("`prefix`")
          template("${`prefix`tmp}")
          delimiters(',')
        );
      };
      filter { "${`prefix`device_name}" ne "" };
    };

    rewrite {
      set("${LEGACY_MSGHDR}${MESSAGE}" value("MESSAGE"));
      set("paloalto_panos" value("PROGRAM"));
      unset(value("`prefix`tmp"));

      # Facility & Level Mapping
      set("local6", value(".palo.facility"));
      set("info",    value(".palo.level") condition("${_panos_severity}" eq "informational"));
      set("notice",  value(".palo.level") condition("${_panos_severity}" eq "low"));
      set("warning", value(".palo.level") condition("${_panos_severity}" eq "medium"));
      set("err",     value(".palo.level") condition("${_panos_severity}" eq "high"));
      set("crit",    value(".palo.level") condition("${_panos_severity}" eq "critical"));
    };

  };
};

application panos[syslog] {
    filter { match("1," value("PROGRAM") type(string) flags(prefix)); };
    parser { panos-parser(); };
};
